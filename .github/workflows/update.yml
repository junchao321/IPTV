name: IPTV Auto Update & Deployment

on:
  schedule:
    - cron: "0 6,18 * * *"  # UTCæ—¶é—´æ¯å¤©6ç‚¹å’Œ18ç‚¹æ‰§è¡Œï¼ˆå¯é€šè¿‡TZç¯å¢ƒå˜é‡è°ƒæ•´ï¼‰
  workflow_dispatch:
    inputs:
      update_reason:
        description: 'è§¦å‘æ›´æ–°çš„åŸå› ï¼ˆé€‰å¡«ï¼‰'
        required: false

jobs:
  update-iptv:
    name: æ›´æ–°IPTVç›´æ’­æºåŠEPGæ•°æ®
    runs-on: ubuntu-22.04
    environment: production
    permissions:
      contents: write  # å¿…éœ€æƒé™ï¼Œç”¨äºæäº¤ä»£ç å˜æ›´
      actions: read    # è¯»å–å·¥ä½œæµæƒé™ï¼ˆé»˜è®¤ï¼‰
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"
          cache: pip  # å¯ç”¨ä¾èµ–ç¼“å­˜

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt  # å»ºè®®æ·»åŠ requirements.txt
        env:
          PYTHONUNBUFFERED: 1  # ç¡®ä¿æ—¥å¿—å®æ—¶è¾“å‡º

      - name: âš™ï¸ é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "$GITHUB_ACTOR@users.noreply.github.com"
        env:
          GITHUB_ACTOR: ${{ github.actor }}  # ä½¿ç”¨ç³»ç»Ÿå†…ç½®å˜é‡

      - name: ğŸš€ è¿è¡Œæ›´æ–°è„šæœ¬
        run: |
          python main.py
        env:
          # å¯åœ¨æ­¤æ·»åŠ æ•æ„Ÿé…ç½®ï¼ˆé€šè¿‡Secretsæ³¨å…¥ï¼‰
          # UPDATE_TOKEN: ${{ secrets.UPDATE_TOKEN }}
          PYTHONPATH: .  # è®¾ç½®Pythonè·¯å¾„

      - name: ğŸ“ æ£€æŸ¥è¾“å‡ºæ–‡ä»¶å˜æ›´
        id: file_changes
        run: |
          # æ£€æŸ¥outputç›®å½•æ˜¯å¦æœ‰æ–°æ–‡ä»¶æˆ–æ›´æ–°
          if [ -z "$(git status --porcelain output/)" ]; then
            echo "::set-output name=has_changes::false"
          else
            echo "::set-output name=has_changes::true"
          fi

      - name: âœ¨ æäº¤æ›´æ–°ç»“æœ
        if: steps.file_changes.outputs.has_changes == 'true'
        run: |
          git add ./output/  # ä»…æäº¤è¾“å‡ºç›®å½•å˜æ›´
          commit_message="Update IPTV sources - $(date +'%Y-%m-%d %H:%M:%S')"
          # æ·»åŠ å¯é€‰çš„ç”¨æˆ·è¾“å…¥åˆ°æäº¤ä¿¡æ¯
          if [ -n "${{ github.event.inputs.update_reason }}" ]; then
            commit_message="${commit_message} (${{ github.event.inputs.update_reason }})"
          fi
          git commit -m "$commit_message"

      - name: ğŸ”„ æ¨é€å˜æ›´åˆ°ä»“åº“
        if: steps.file_changes.outputs.has_changes == 'true'
        uses: actions/git@v4
        with:
          push_options: --force-with-lease  # å®‰å…¨æ¨é€ç­–ç•¥

      - name: ğŸ“¬ å‘é€æ›´æ–°é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½å‘é€é€šçŸ¥
        run: |
          # å¯åœ¨æ­¤æ·»åŠ Slack/Discord/Webhooké€šçŸ¥é€»è¾‘
          # curl -X POST ...
          echo "IPTVæ›´æ–°ä»»åŠ¡å®Œæˆï¼ŒçŠ¶æ€ï¼š${{ job.status }}"

    # å¯é€‰ï¼šè®¾ç½®ä»»åŠ¡å¤±è´¥æ—¶çš„é€šçŸ¥æœºåˆ¶
    # failure:
    #   steps:
    #     - name: å‘é€å¤±è´¥é€šçŸ¥
    #       run: |
    #         # é€šçŸ¥è„šæœ¬é€»è¾‘

    # ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå»ºè®®é€šè¿‡Secretsç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼‰
    # env:
    #   DB_CONN_STR: ${{ secrets.DB_CONN_STR }}
    #   API_TOKEN: ${{ secrets.API_TOKEN }}
