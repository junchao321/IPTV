name: IPTV Auto Update

on:
  schedule:
    - cron: "0 6,18 * * *"  # UTC时间每日6点和18点更新（可通过TZ环境变量调整）
  workflow_dispatch:
    inputs:
      reason:
        description: "手动更新原因（选填）"
        required: false

jobs:
  update-iptv:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # 必需权限，用于提交输出文件变更

    steps:
      # 1. 检出代码（完整历史）
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取所有提交历史

      # 2. 设置Python环境（带依赖缓存）
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"
          cache: pip  # 启用Pip缓存加速

      # 3. 安装项目依赖（通过requirements.txt）
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      # 4. 配置Git用户信息（使用GitHub内置变量）
      - name: Configure Git User
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      # 5. 运行主更新脚本（设置正确模块搜索路径）
      - name: Run Update Script
        run: python main.py
        env:
          PYTHONPATH: .  # 关键：将当前目录加入模块搜索路径

      # 6. 检测output目录变更
      - name: Detect File Changes
        id: changes
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD -- output/)
          if [ -n "$CHANGED_FILES" ]; then
            echo "::set-output name=has_changes::true"
          else
            echo "::set-output name=has_changes::false"
          fi

      # 7. 提交变更（仅在有文件变化时执行）
      - name: Commit Output Changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add output/  # 仅跟踪output目录
          commit_message="Update IPTV Sources - $(date +'%Y-%m-%d %H:%M:%S')"
          # 添加手动输入的更新原因（如果有）
          if [ -n "${{ github.event.inputs.reason }}" ]; then
            commit_message="${commit_message} (Reason: ${{ github.event.inputs.reason }})"
          fi
          git commit -m "$commit_message"

      # 8. 安全推送变更（使用标准git push，移除错误的actions/git@v4）
      - name: Push to Repository
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ github.ref_name }} --force-with-lease  # 防止分支冲突

    # 环境变量配置（如需敏感信息，通过Secrets注入）
    # env:
    #   API_TOKEN: ${{ secrets.API_TOKEN }}
